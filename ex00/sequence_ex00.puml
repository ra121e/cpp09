@startuml ex00_sequence
title ex00 - BitcoinExchange シーケンス図

actor User
participant Main as "main()"
participant BitcoinExchange as "BitcoinExchange"
participant HistoricalDataFileCSV as "HistoricalDataFileCSV"
participant InputDataFilePip as "InputDataFilePip"
participant RateFinder as "RateFinder"
participant StdOut as "stdout"
participant StdErr as "stderr"
participant Map as "RateMap\n(std::map<string,double>)"

User -> Main: 実行 (./btc input.txt)
Main -> HistoricalDataFileCSV: HistoricalDataFileCSV(header_format)
Main -> HistoricalDataFileCSV: parseFile("data.csv")
HistoricalDataFileCSV --> Main: (ratemap を構築して準備完了)
Main -> BitcoinExchange: BitcoinExchange(historical_data_file_csv)

Main -> BitcoinExchange: evaluateBTCTimeSeries("input.txt")
BitcoinExchange -> InputDataFilePip: parseFile("input.txt")
InputDataFilePip --> BitcoinExchange: ready

loop 各入力行で
    BitcoinExchange -> InputDataFilePip: readNextDateAmount()
    alt 有効な行
        InputDataFilePip --> BitcoinExchange: date, amount
        BitcoinExchange -> HistoricalDataFileCSV: getRateMap()
        HistoricalDataFileCSV --> BitcoinExchange: Map
        BitcoinExchange -> RateFinder: findRate(Map, date)
        alt レートが見つかる
            RateFinder --> BitcoinExchange: exchange_rate
            BitcoinExchange -> StdOut: print "date => amount = amount * exchange_rate"
        else レートが見つからない / 例外
            RateFinder --> BitcoinExchange: throw exception
            BitcoinExchange -> StdErr: print エラーメッセージ
        end
    else 無効な行（パース/検証失敗）
        InputDataFilePip -> StdErr: log invalid line (skip)
    end
end

BitcoinExchange --> Main: evaluate 完了
Main -> User: 終了コード

@enduml
