@startuml ex00_sequence
title ex00 - BitcoinExchange シーケンス図

actor User
participant Main as "main()"
participant BitcoinExchange as "BitcoinExchange"
participant HistoricalDataFileCSV as "HistoricalDataFileCSV"
participant InputDataFilePip as "InputDataFilePip"
participant RateFinder as "RateFinder"
participant StdOut as "stdout"
participant StdErr as "stderr"

User -> Main: 実行 (./btc input.txt)
Main -> BitcoinExchange: BitcoinExchange(header_format)
Main -> BitcoinExchange: setHistoricalRate("data.csv")
BitcoinExchange -> HistoricalDataFileCSV: parseFile("data.csv")
HistoricalDataFileCSV --> BitcoinExchange: (内部にratemapを構築)

Main -> BitcoinExchange: evaluateBTCTimeSeries("input.txt")
BitcoinExchange -> InputDataFilePip: initialize("input.txt")
InputDataFilePip --> BitcoinExchange: ready

loop 各入力行で
    BitcoinExchange -> InputDataFilePip: readNextDateAmount()
    alt 有効な行
        InputDataFilePip --> BitcoinExchange: date, amount
        BitcoinExchange -> RateFinder: findRate(HistoricalDataFileCSV.getRateMap(), date)
        alt レートが見つかる
            RateFinder --> BitcoinExchange: exchange_rate
            BitcoinExchange -> StdOut: print "date => amount = amount * exchange_rate"
        else レートが見つからない
            RateFinder --> BitcoinExchange: throw exception
            BitcoinExchange -> StdErr: print エラーメッセージ
        end
    else 無効な行（パース/検証失敗）
        InputDataFilePip -> StdErr: log invalid line (skip)
    end
end

BitcoinExchange --> Main: evaluate 完了
Main -> User: 終了コード

@enduml
